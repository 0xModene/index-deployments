# index-coop Deployments

## Install
```
cp .env.default .env
yarn
```

## Etherscan verification

Set `ETHERSCAN_API_KEY=8UC6MJ3E5R2AXIHFZQ6JNU2U5QCV1EZGX5Y` in `.env`

After deploying, run the command for your network:
```
yarn etherscan:kovan
yarn etherscan:staging_mainnet
yarn etherscan:production
```

**Notes**
+ Etherscan recommends you wait 5 confirmations (~2 minutes) before attempting to verify.
+ It's possible for verification to fail because of [solidity issue 9573][1] which causes Etherscan
  to generate different bytecode from a minimized contract set than what was generated locally with
  all contracts in the project. If that happens, you can deploy flattened contracts from remix
  and manually verify on Etherscan *OR*
    + remove all (or most) contracts not in the inheritance tree of your contract from `contracts/`
    + deploy again
    + run the etherscan command at the cli.


[1]: https://github.com/ethereum/solidity/issues/9573#issuecomment-721632715

## Multisig Transaction Utilities

#### `yarn tx`

The `tx` yarn command lets you view transactions deferred for multi-sig execution and compare data
generated by the deployments scripts with data generated by the browser multisig wallets.

**Usage**
```
USAGE: yarn tx <command> [args]

 Commands:
  list:                    lists all deferred transactions by transaction number with description
  view <tx-num>:           shows detail for a deferred transaction
  compare <tx-num> <data>: checks that tx data at `tx-num` matches `data` (from wallet)

 Options:
  --file <descriptor>:     `deployments/outputs/*.json` file to query (defaults: `1-production`)
```

**Examples**

`yarn tx list`
```
Tx   Description
====  ===========
49    Add TradeModule to Controller
50    Add OneInchExchangeAdapter to IntegrationRegistry
55    Add WrapModule to Controller
...
```

`yarn tx view 73`
```
Add GovernanceModule to Controller
==================================
{
  "args": [
   "0x2579D2B186BbA16999016dB077b4874A7520f92e"
  ],
  "signature": "addModule(address)",
  "data": "0x1ed86f190000000000000000000000002579d2b186bba16999016db077b4874a7520f92e"
}
```

`yarn tx compare 73 0xc642747400000....`
```
> Add GovernanceModule to Controller
> ==================================
> OK (data matches)
```

### `yarn console`

Hardhat console exposes a `set` variable which gives you access to all contract methods and
dependency addresses. It can be used to compose transaction data for arbitrary methods
and inputs, as well as fetch recent multisig transactions from Etherscan. The interface is:

```ts
set.addresses: object
set.addressStartsWith(prefix: string)
set.methods(contractName: string)
set.data(methodName: string, args: string[])
await set.recent(maxRecords?: number)
```

**Usage**

`yarn console`
```
> set.addresses
{
  IndexToken: '0x0954906da0Bf32d5479e25f46056d22f08464cab',
  MerkleDistributor: '0xDD111F0fc07F4D89ED6ff96DBAB19a61450b8435',
  StakingRewards: '0x8f06FBA4684B5E0988F215a47775Bb611Af0F986',
  ...
  DPI: '0x1494CA1F11D487c2bBe4543E90080AeBa4BA3C2b',
  DPI_ETH_UNI_POOL: '0x4d5ef58aac27d99935e5b6b4a6778ff292059991',
  WETH: '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2',
  ...
}

> set.addressStartsWith('r')
{
  RewardsNov20MerkleDistributor: '0xa6bb7b6B2C5C3477F20686B98Ea09796F8f93184',
  RewardsDec20MerkleDistributor: '0xEB1CbC809b21DddC71F0F9eDc234eeE6fB29aCEE',
  RewardsJan21MerkleDistributor: '0x319B852cd28B1CbEb029A3017E787B98e62Fd4e2',
  RewardsFeb21MerkleDistributor: '0xCa3C3570beb35E5d3D85BCd8ad8F88BefaccFF10'
}

> set.getAddressName('0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D')
'UNISWAP_V2_ROUTER'

> await set.recent()
Fetching recent txs for multisig wallet 0xF8523c551763FE4261A28313015267F163de7541 from etherscan...
[
  ...
  {
    time: 'Fri Mar 26 2021 11:42:31 GMT-0700 (Pacific Daylight Time)',
    txHash:
     '0x95c9d3a5b23219b676fe7ab3320d83795890b5e243b206a46b47009b99d5322a',
    contract: 'FlexibleLeverageStrategyAdapter',
    method:
     'setExecutionSettings((uint256,uint256,uint256,uint256,string,bytes))',
    paramNames: [ '_newExecutionSettings' ],
    args:
     [ '10000000000000000,600000000000000000000,30,20000000000000000,SushiswapExchangeAdapter,0x' ]
  },
]

> set.methods("IndexToken")
[
  'DELEGATION_TYPEHASH()',
  'DOMAIN_TYPEHASH()',
  'allowance(address,address)',
  'approve(address,uint256)',
  ...
]

> set.data("transfer(address,uint256)", [ "0x5bC4249641B4bf4E3....", "381000000000000...." ])
'0xa9059cbb0000000000000000000000005bc4249641b4bf4e37ef513f3fa5c63ecab348810000....'
```
